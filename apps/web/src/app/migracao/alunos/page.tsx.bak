"use client";

import { useEffect, useMemo, useState, useRef } from "react";
import * as XLSX from "xlsx";
import { useSearchParams } from 'next/navigation';
import { createClient } from "@/lib/supabaseClient";
import {
  Loader2,
  Upload,
  Map,
  Eye,
  CheckCircle,
  AlertTriangle,
  ArrowLeft,
  Users,
  Download,
  RefreshCw,
  Info,
} from "lucide-react";
import BackfillStep from "@/components/escola/importacao/wizard/steps/BackfillStep";

import { ColumnMapper } from "~/components/migracao/ColumnMapper";
import { ErrorList } from "~/components/migracao/ErrorList";
import { PreviewTable } from "~/components/migracao/PreviewTable";
import { UploadField } from "~/components/migracao/UploadField";
import type { AlunoStagingRecord, ErroImportacao, ImportResult, MappedColumns } from "~types/migracao";

const STEPS = [
  { id: 1, title: "Upload", icon: Upload, description: "Faça upload do arquivo CSV" },
  { id: 2, title: "Mapeamento", icon: Map, description: "Mapeie as colunas do arquivo" },
  { id: 3, title: "Pré-visualização", icon: Eye, description: "Revise os dados importáveis" },
  { id: 4, title: "Backfill Acadêmico", icon: Eye, description: "Criar sessões, classes, cursos e turmas" },
  { id: 5, title: "Importação", icon: Eye, description: "Criar/atualizar alunos" },
  { id: 6, title: "Finalização", icon: CheckCircle, description: "Resumo da importação" },
];

export default function AlunoMigrationWizard() {
  const STORAGE_KEY = 'moxi:wizard:importacao:alunos';
  const [step, setStep] = useState(1);
  const [file, setFile] = useState<File | null>(null);
  const [headers, setHeaders] = useState<string[]>([]);
  const [mapping, setMapping] = useState<MappedColumns>({});
  const [preview, setPreview] = useState<AlunoStagingRecord[]>([]);
  const [apiErrors, setApiErrors] = useState<string[]>([]);
  const [importId, setImportId] = useState<string | null>(null);
  const [escolaId, setEscolaId] = useState<string | null>(null);
  const [userId, setUserId] = useState<string | null>(null);
  const [importErrors, setImportErrors] = useState<ErroImportacao[]>([]);
  const [importResult, setImportResult] = useState<ImportResult | null>(null);
  const [matriculaBatches, setMatriculaBatches] = useState<any[]>([]);
  const [selectedBatches, setSelectedBatches] = useState<Record<number, boolean>>({});
  const [matriculando, setMatriculando] = useState(false);
  const [progressTotal, setProgressTotal] = useState(0);
  const [progressDone, setProgressDone] = useState(0);
  const [matriculaSummary, setMatriculaSummary] = useState<Array<{ turma_nome: string; turma_id: string | null; success: number; errors: number }>>([]);
  const [loading, setLoading] = useState(false);
  const [anoLetivo, setAnoLetivo] = useState<number>(new Date().getFullYear());

  const supabase = useMemo(() => createClient(), []);
  const searchParams = useSearchParams();
  const deepApplied = useRef(false);

  const batchKey = (b: any) =>
    [
      b?.ano_letivo ?? '',
      String(b?.turma_codigo || '').toUpperCase(),
      b?.turma_id ?? '',
    ].join('|');

  // Carrega sessão e resolve contexto de escola de forma robusta
  useEffect(() => {
    const loadSession = async () => {
      try {
        const {
          data: { session },
        } = await supabase.auth.getSession();
        setUserId(session?.user?.id ?? null);
        const appMeta = session?.user?.app_metadata as { escola_id?: string } | undefined;
        let escola = appMeta?.escola_id ?? null;

        // Fallbacks: profiles.current_escola_id -> profiles.escola_id -> escola_users.escola_id
        if (!escola && session?.user?.id) {
          try {
            const { data: prof } = await supabase
              .from('profiles' as any)
              .select('current_escola_id, escola_id, user_id')
              .eq('user_id', session.user.id)
              .order('created_at', { ascending: false })
              .limit(1);
            const escolaFromProfile = (prof?.[0] as any)?.current_escola_id || (prof?.[0] as any)?.escola_id || null;
            escola = (escolaFromProfile as string | null) ?? escola;
          } catch {
            // ignore and try next fallback
          }

          if (!escola) {
            try {
              const { data: vinc } = await supabase
                .from('escola_users' as any)
                .select('escola_id')
                .eq('user_id', session.user.id)
                .limit(1);
              const escolaFromVinc = (vinc?.[0] as any)?.escola_id || null;
              escola = (escolaFromVinc as string | null) ?? escola;
            } catch {
              // ignore
            }
          }
        }

        setEscolaId(escola);
      } catch {
        setUserId(null);
        setEscolaId(null);
      }
    };

    loadSession();
  }, [supabase]);

  // Restaurar progresso salvo após identificar escolaId
  useEffect(() => {
    try {
      if (!escolaId) return;
      const raw = typeof window !== 'undefined' ? window.localStorage.getItem(STORAGE_KEY) : null;
      if (!raw) return;
      const st = JSON.parse(raw || '{}');
      if (st && st.escolaId === escolaId) {
        if (st.importId) setImportId(st.importId);
        if (st.step && Number.isFinite(st.step)) setStep(st.step);
        if (st.mapping) setMapping(st.mapping);
      }
    } catch {}
  }, [escolaId]);

  // Persistir progresso minimal (idempotente)
  useEffect(() => {
    try {
      // Persist também seleção de lotes (por keys) se existir
      let selectedBatchKeys: string[] | undefined = undefined;
      try {
        const keys: string[] = [];
        matriculaBatches.forEach((b, idx) => { if (selectedBatches[idx]) keys.push(batchKey(b)); });
        selectedBatchKeys = keys;
      } catch {}
      const payload = { step, importId, escolaId, mapping, selectedBatchKeys } as any;
      if (typeof window !== 'undefined') window.localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    } catch {}
  }, [step, importId, escolaId, mapping, selectedBatches, matriculaBatches]);

  // Deep link: ?importId=...&step=review|<n>
  useEffect(() => {
    try {
      if (deepApplied.current) return;
      if (!escolaId) return;
      const qImportId = searchParams?.get('importId');
      if (!qImportId) return;
      deepApplied.current = true;
      setImportId(qImportId);
      const qStep = (searchParams?.get('step') || '').toLowerCase();
      if (qStep === 'review') {
        setStep(6);
      } else if (qStep && !Number.isNaN(Number(qStep))) {
        setStep(Math.max(1, Math.min(7, Number(qStep))));
      } else {
        setStep(6);
      }
    } catch {}
  }, [searchParams, escolaId]);

  const extractHeaders = async () => {
    if (!file) return;

    try {
      const lowerName = file.name.toLowerCase();
      const contentType = file.type || "";
      const isXlsx =
        lowerName.endsWith(".xlsx") ||
        contentType === "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";

      if (isXlsx) {
        const buffer = await file.arrayBuffer();
        const wb = XLSX.read(buffer, { type: "array" });
        const firstSheet = wb.SheetNames[0];
        const rows = firstSheet ? (XLSX.utils.sheet_to_json(wb.Sheets[firstSheet], { header: 1 }) as any[][]) : [];
        const headerRow = rows?.[0] || [];
        const normalized = headerRow.map((h) => (h ? String(h).trim() : "")).filter(Boolean) as string[];
        setHeaders(normalized);
        return;
      }

      const text = await file.text();
      const [firstLine] = text.split(/\r?\n/);
      if (!firstLine) return;
      const delimiter = firstLine.includes(";") && !firstLine.includes(",") ? ";" : ",";
      setHeaders(firstLine.split(delimiter).map((h) => h.trim()));
    } catch (error) {
      console.error("Erro ao extrair headers:", error);
      setApiErrors((prev) => [...prev, "Não foi possível ler o cabeçalho do arquivo."]);
    }
  };

  // Regras de mapeamento mínimo para importar alunos com segurança
  const mappingStatus = useMemo(() => {
    const missing: string[] = [];

    if (!mapping.nome) missing.push("Nome");
    if (!mapping.data_nascimento) missing.push("Data de Nascimento");
    if (!mapping.sexo) missing.push("Gênero (M/F)");

    return {
      ok: missing.length === 0,
      missing,
    };
  }, [mapping]);

  const handleUpload = async () => {
    if (!file || !escolaId) {
      setApiErrors([
        !file ? "Selecione um arquivo" : "Escola não identificada. Faça login novamente ou contacte o administrador.",
      ]);
      return;
    }

    setLoading(true);
    setApiErrors([]);

    try {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("escolaId", escolaId);
      if (userId) formData.append("userId", userId);

      const response = await fetch("/api/migracao/upload", {
        method: "POST",
        body: formData,
      });

      const payload = await response.json();

      if (!response.ok) {
        throw new Error(payload.error || "Erro no upload");
      }

      setImportId(payload.importId);
      setImportErrors([]);
      setImportResult(null);
      setStep(2);
      await extractHeaders();
    } catch (error) {
      setApiErrors([error instanceof Error ? error.message : "Erro de conexão no upload"]);
    } finally {
      setLoading(false);
    }
  };

  const handleValidate = async () => {
    if (!importId || !escolaId || !anoLetivo) {
      setApiErrors(["Complete o upload e selecione o ano letivo primeiro."]);
      return;
    }
    
    if (!mappingStatus.ok) {
      setApiErrors([`Mapeie os campos obrigatórios: ${mappingStatus.missing.join(", ")}.`]);
      return;
    }

    setLoading(true);
    setApiErrors([]);

    try {
      const response = await fetch("/api/migracao/alunos/validar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ importId, escolaId, columnMap: mapping, anoLetivo }),
      });

      const payload = await response.json();

      if (!response.ok) {
        throw new Error(payload.error || "Erro na validação");
      }

      setPreview(payload.preview);
      setStep(3);
    } catch (error) {
      setApiErrors([error instanceof Error ? error.message : "Erro de validação"]);
    } finally {
      setLoading(false);
    }
  };

  const handleImport = async () => {
    if (!importId || !escolaId || !anoLetivo) {
      setApiErrors(["Importação inválida ou ano letivo não definido. Tente reiniciar o processo."]);
      return;
    }

    setLoading(true);
    setApiErrors([]);

    try {
      const response = await fetch("/api/migracao/alunos/importar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ importId, escolaId, anoLetivo }),
      });

      const payload = await response.json();

      if (!response.ok) {
        throw new Error(payload.error || "Erro na importação");
      }

      setImportResult(payload.result ?? null);
      setStep(6);
      await fetchMatriculaPreview();

      const errorsResponse = await fetch(`/api/migracao/${importId}/erros`);
      if (errorsResponse.ok) {
        const errorsPayload = await errorsResponse.json();
        setImportErrors(errorsPayload.errors ?? []);
      }

      const warnings = (payload.result?.warnings_turma as number | undefined) ?? 0;
      if (warnings > 0) {
        setApiErrors((prev) => [
          ...prev,
          `Importação concluída com ${warnings} alunos sem matrícula porque a turma não foi encontrada. Consulte o relatório de erros e crie/mapeie as turmas.`,
        ]);
      }

      const turmasCriadas = (payload.result?.turmas_created as number | undefined) ?? 0;
      if (turmasCriadas > 0) {
        setApiErrors((prev) => [
          ...prev,
          `Importação criou ${turmasCriadas} turma(s) em modo rascunho. Valide-as em "Turmas" para ajustar curso/classe/turno/capacidade antes de liberar finanças.`,
        ]);
      }
    } catch (error) {
      setApiErrors([error instanceof Error ? error.message : "Erro de conexão na importação"]);
    } finally {
      setLoading(false);
    }
  };

  const fetchMatriculaPreview = async () => {
    try {
      if (!importId || !escolaId) return;
      const res = await fetch(`/api/migracao/${encodeURIComponent(importId)}/matricula/preview?escola_id=${encodeURIComponent(escolaId)}`, { cache: 'no-store' });
      const json = await res.json();
      if (res.ok && json?.ok) {
        setMatriculaBatches(json.batches || []);
        const sel: Record<number, boolean> = {};
        // Tenta restaurar seleção anterior por keys
        let savedKeys = [] as string[];
        try {
          const raw = typeof window !== 'undefined' ? window.localStorage.getItem(STORAGE_KEY) : null;
          if (raw) {
            const st = JSON.parse(raw || '{}');
            if (st && st.escolaId === escolaId && st.importId === importId && Array.isArray(st.selectedBatchKeys)) {
              savedKeys = st.selectedBatchKeys as string[];
            }
          }
        } catch {}
        const savedSet = new Set(savedKeys);
        (json.batches || []).forEach((b: any, idx: number) => {
          const key = batchKey(b);
          if (savedSet.size > 0) sel[idx] = savedSet.has(key);
          else sel[idx] = true;
        });
        setSelectedBatches(sel);
      }
    } catch {}
  };

  // Ao entrar no passo 6 com importId válido, carregue o preview
  useEffect(() => {
    if (step === 6 && importId && escolaId) {
      fetchMatriculaPreview();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [step, importId, escolaId]);

  const resetWizard = () => {
    setStep(1);
    setFile(null);
    setPreview([]);
    setImportResult(null);
    setImportErrors([]);
    setApiErrors([]);
    setMapping({});
    setHeaders([]);
    setImportId(null);
    try { if (typeof window !== 'undefined') window.localStorage.removeItem(STORAGE_KEY); } catch {}
  };

  const StepProgress = () => (
    <div className="bg-white/80 backdrop-blur rounded-2xl border border-slate-200 mb-6 px-5 py-4 shadow-sm">
      <div className="flex items-center justify-between mb-4 gap-4">
        <div>
          <h2 className="text-base font-semibold text-slate-900">Progresso da importação</h2>
          <p className="text-xs text-slate-500">
            Siga os passos na ordem para evitar erros nos dados dos alunos.
          </p>
        </div>
        <div className="text-right">
          <div className="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1">
            <span className="text-xs font-medium text-slate-500">Passo atual</span>
            <span className="text-sm font-semibold text-blue-600">
              {step}/{STEPS.length}
            </span>
          </div>
        </div>
      </div>

      <div className="flex items-center justify-between relative">
        <div className="absolute left-4 right-4 top-1/2 h-px bg-slate-200 -z-10" />
        {STEPS.map(({ id, title, icon: Icon }) => {
          const isCompleted = id < step;
          const isActive = id === step;

          return (
            <div key={id} className="flex flex-col items-center flex-1">
              <div
                className={`
                  flex items-center justify-center rounded-full w-9 h-9 mb-1
                  border text-xs
                  ${
                    isCompleted
                      ? "bg-emerald-50 border-emerald-200 text-emerald-600"
                      : isActive
                      ? "bg-blue-50 border-blue-200 text-blue-600"
                      : "bg-slate-50 border-slate-200 text-slate-400"
                  }
                `}
              >
                {isCompleted ? (
                  <CheckCircle className="h-4 w-4" />
                ) : (
                  <Icon className="h-4 w-4" />
                )}
              </div>
              <span
                className={`
                  text-[11px] font-medium text-center leading-tight
                  ${
                    isActive
                      ? "text-blue-700"
                      : isCompleted
                      ? "text-emerald-700"
                      : "text-slate-400"
                  }
                `}
              >
                {title}
              </span>
            </div>
          );
        })}
      </div>

      <div className="mt-3 w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
        <div
          className="bg-blue-500 h-1.5 rounded-full transition-all duration-300"
          style={{ width: `${((step - 1) / (STEPS.length - 1)) * 100}%` }}
        />
      </div>
    </div>
  );

  const StepCard = ({
    stepNumber,
    title,
    description,
    children,
  }: {
    stepNumber: number;
    title: string;
    description: string;
    children: React.ReactNode;
  }) => {
    const isDisabled = step < stepNumber;
    const isCurrent = step === stepNumber;
    const isDone = step > stepNumber;

    return (
      <section
        className={`
          rounded-2xl border bg-white/90 backdrop-blur shadow-sm mb-4 transition-all
          ${
            isDisabled
              ? "border-slate-100 opacity-40 pointer-events-none"
              : "border-slate-200"
          }
          ${isCurrent ? "ring-1 ring-blue-100" : ""}
        `}
      >
        <header className="flex items-center justify-between gap-3 px-5 py-3 border-b border-slate-100">
          <div className="flex items-center gap-3">
            <div
              className={`
                flex items-center justify-center rounded-full w-7 h-7 text-xs font-semibold
                ${
                  isDone
                    ? "bg-emerald-50 text-emerald-600"
                    : isCurrent
                    ? "bg-blue-600 text-white"
                    : "bg-slate-200 text-slate-600"
                }
              `}
            >
              {isDone ? <CheckCircle className="w-4 h-4" /> : stepNumber}
            </div>
            <div>
              <h3 className="text-sm font-semibold text-slate-900">{title}</h3>
              <p className="text-xs text-slate-500">{description}</p>
            </div>
          </div>
          {!isDisabled && (
            <span className="text-[11px] font-medium text-slate-400">
              {isDone ? "Concluído" : isCurrent ? "Em andamento" : "Próximo"}
            </span>
          )}
        </header>

        <div className="px-5 py-4 space-y-4">{children}</div>
      </section>
    );
  };

  const ActionButton = ({
    onClick,
    disabled,
    loading: btnLoading,
    icon: Icon,
    children,
  }: {
    onClick: () => void;
    disabled?: boolean;
    loading?: boolean;
    icon: React.ComponentType<{ className?: string }>;
    children: string;
  }) => (
    <button
      onClick={onClick}
      disabled={disabled || btnLoading}
      className={`
        inline-flex items-center justify-center gap-2
        rounded-lg px-4 py-2.5 text-sm font-medium
        bg-blue-600 text-white
        hover:bg-blue-700
        disabled:opacity-50 disabled:cursor-not-allowed
        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
        transition-colors
        w-full sm:w-auto
      `}
    >
      {btnLoading ? (
        <Loader2 className="h-4 w-4 animate-spin" />
      ) : (
        <Icon className="h-4 w-4" />
      )}
      <span>{btnLoading ? "Processando..." : children}</span>
    </button>
  );

  const ErrorAlert = () =>
    apiErrors.length > 0 && (
      <div className="bg-red-50/80 border border-red-200 rounded-lg px-3 py-2.5 space-y-1">
        <div className="flex items-center gap-2 text-xs font-semibold text-red-800">
          <AlertTriangle className="h-4 w-4" />
          <span>Foram encontrados problemas nesta etapa:</span>
        </div>
        {apiErrors.map((error, index) => (
          <div key={index} className="flex items-start gap-2 text-xs text-red-700 pl-6">
            <span>• {error}</span>
          </div>
        ))}
      </div>
    );

  const ResultsSummary = () =>
    importResult && (
      <div className="grid grid-cols-1 sm:grid-cols-5 gap-3">
        <div className="bg-emerald-50 border border-emerald-200 rounded-lg px-3 py-3 text-center">
          <div className="text-lg font-semibold text-emerald-700">
            {importResult.imported ?? 0}
          </div>
          <div className="text-xs text-emerald-800">Importados</div>
        </div>
        <div className="bg-amber-50 border border-amber-200 rounded-lg px-3 py-3 text-center">
          <div className="text-lg font-semibold text-amber-700">
            {importResult.skipped ?? 0}
          </div>
          <div className="text-xs text-amber-800">Ignorados</div>
        </div>
        <div className="bg-red-50 border border-red-200 rounded-lg px-3 py-3 text-center">
          <div className="text-lg font-semibold text-red-700">
            {importResult.errors ?? 0}
          </div>
          <div className="text-xs text-red-800">Erros</div>
        </div>
        <div className="bg-amber-50/70 border border-amber-200 rounded-lg px-3 py-3 text-center">
          <div className="text-lg font-semibold text-amber-700">
            {importResult.warnings_turma ?? 0}
          </div>
          <div className="text-xs text-amber-800">Sem matrícula (turma não encontrada)</div>
        </div>
        <div className="bg-blue-50 border border-blue-200 rounded-lg px-3 py-3 text-center">
          <div className="text-lg font-semibold text-blue-700">
            {importResult.turmas_created ?? 0}
          </div>
          <div className="text-xs text-blue-800">Turmas criadas (rascunho)</div>
        </div>
      </div>
    );

  return (
    <div className="min-h-screen bg-slate-50/80 py-8">
      <div className="max-w-5xl mx-auto px-4 sm:px-6">
        {/* Header */}
        <div className="mb-6">
          <button
            onClick={() => window.history.back()}
            className="inline-flex items-center gap-2 text-xs sm:text-sm text-slate-500 hover:text-slate-800 mb-3 transition-colors"
          >
            <ArrowLeft className="h-4 w-4" />
            Voltar
          </button>

          <div className="bg-white/90 backdrop-blur border border-slate-200 rounded-2xl px-5 py-4 shadow-sm flex items-center justify-between gap-3">
            <div className="flex items-center gap-3">
              <div className="flex items-center justify-center h-9 w-9 rounded-full bg-blue-50 text-blue-600">
                <Users className="h-5 w-5" />
              </div>
              <div>
                <h1 className="text-base sm:text-lg font-semibold text-slate-900">
                  Migração de Alunos
                </h1>
                <p className="text-xs sm:text-sm text-slate-500">
                  Importe alunos em lote através de um arquivo CSV estruturado.
                </p>
              </div>
            </div>
            <div className="hidden sm:flex flex-col items-end gap-1">
              <span className="text-[11px] uppercase tracking-wide text-slate-400 font-medium">
                Escola atual
              </span>
              <span className="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-1 text-[11px] font-medium text-slate-700">
                {escolaId ? escolaId : "Não identificada"}
              </span>
            </div>
          </div>

          {!escolaId && (
            <div className="mt-3 bg-amber-50 border border-amber-200 text-amber-800 text-xs rounded-lg px-3 py-2 flex items-start gap-2">
              <Info className="h-4 w-4 mt-0.5 flex-shrink-0" />
              <p>
                Não foi possível identificar a escola do usuário. A importação precisa de um{" "}
                <span className="font-semibold">escola_id</span> válido para ser concluída. Verifique o login
                ou contacte o administrador.
              </p>
            </div>
          )}
        </div>

        <StepProgress />

        {/* ALERTA GLOBAL DE ERROS */}
        {apiErrors.length > 0 && (
          <div className="mb-4">
            <ErrorAlert />
          </div>
        )}

        {/* Passo 1: Upload */}
        <StepCard
          stepNumber={1}
          title="Upload do arquivo"
          description="Selecione o arquivo CSV com os dados dos alunos."
        >
          <div className="space-y-4">
            <UploadField onFileSelected={setFile} />
            <div className="rounded-lg border border-slate-100 bg-slate-50/60 px-3 py-2.5 text-[11px] space-y-1.5">
              <div className="flex items-center gap-2 font-medium text-slate-700">
                <Info className="h-3.5 w-3.5" />
                <span>Requisitos do ficheiro CSV:</span>
              </div>
              <ul className="pl-5 space-y-0.5 text-slate-600 list-disc">
                <li>Formato CSV separado por vírgula (,) ou ponto e vírgula (;).</li>
                <li>A primeira linha deve conter os cabeçalhos das colunas.</li>
                <li>Colunas obrigatórias: <strong>Nome</strong>, <strong>Data de Nascimento</strong>, <strong>Telefone do Encarregado</strong>, e <strong>Código da Turma</strong>.</li>
                <li>Opcional recomendado: <strong>Número de Processo</strong> (será gerado se não existir).</li>
              </ul>
            </div>
            <div className="flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
              <p className="text-[11px] text-slate-500">
                Certifique-se que o seu ficheiro cumpre os requisitos antes de enviar.
              </p>
              <ActionButton
                onClick={handleUpload}
                disabled={!file || !escolaId}
                loading={loading && step === 1}
                icon={Upload}
              >
                Enviar arquivo
              </ActionButton>
            </div>
          </div>
        </StepCard>

        {/* Passo 2: Mapeamento */}
        {step >= 2 && (
          <StepCard
            stepNumber={2}
            title="Mapeamento de colunas"
            description="Relacione as colunas do arquivo com os campos do sistema."
          >
            <div className="space-y-4">
              {/* ANO LETIVO SELECTOR */}
              <div className="p-3 rounded-lg border border-blue-100 bg-blue-50/60">
                <label htmlFor="anoLetivo" className="block text-xs font-medium text-slate-700 mb-1">
                  Ano Letivo de Importação
                </label>
                <select
                  id="anoLetivo"
                  value={anoLetivo}
                  onChange={(e) => setAnoLetivo(Number(e.target.value))}
                  className="block w-full sm:w-1/3 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                >
                  <option value={new Date().getFullYear() -1}>{new Date().getFullYear() -1}</option>
                  <option value={new Date().getFullYear()}>{new Date().getFullYear()}</option>
                  <option value={new Date().getFullYear() + 1}>{new Date().getFullYear() + 1}</option>
                </select>
                <p className="text-[11px] text-slate-500 mt-1">Todos os alunos serão importados para este ano letivo.</p>
              </div>

              {/* Checklist de campos obrigatórios */}
              <div className="rounded-lg border border-slate-100 bg-slate-50/60 px-3 py-2.5 text-[11px] space-y-1.5">
                <div className="flex items-center gap-2 font-medium text-slate-700">
                  <Info className="h-3.5 w-3.5" />
                  <span>Campos obrigatórios para importação:</span>
                </div>
                <ul className="pl-5 space-y-0.5 text-slate-600 list-disc">
                  <li>Nome</li>
                  <li>Data de Nascimento</li>
                  <li>Telefone do Encarregado</li>
                  <li>Código da Turma</li>
                </ul>
                {!mappingStatus.ok && (
                  <p className="mt-1 text-[11px] text-red-600">
                    Falta mapear: {mappingStatus.missing.join(" · ")}
                  </p>
                )}
                {mappingStatus.ok && (
                  <p className="mt-1 text-[11px] text-emerald-700">
                    ✅ Mapeamento obrigatório completo. Pode prosseguir para validação.
                  </p>
                )}
              </div>

              <ColumnMapper headers={headers} mapping={mapping} onChange={setMapping} />

              <div className="flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
                <p className="text-[11px] text-slate-500">
                  Campos obrigatórios devem estar mapeados corretamente antes de continuar.
                </p>
                <ActionButton
                  onClick={handleValidate}
                  loading={loading && step === 2}
                  disabled={!mappingStatus.ok || !anoLetivo}
                  icon={Eye}
                >
                  Validar dados
                </ActionButton>
              </div>
            </div>
          </StepCard>
        )}

        {/* Passo 3: Pré-visualização */}
        {step >= 3 && (
          <StepCard
            stepNumber={3}
            title="Pré-visualização"
            description="Revise uma amostra dos dados que serão importados."
          >
            <div className="space-y-4">
              <PreviewTable records={preview} />
              <div className="flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
                <p className="text-[11px] text-slate-500">
                  Confirme se os dados estão consistentes. Em seguida, criaremos automaticamente a estrutura acadêmica faltante (anos letivos, classes, cursos, turmas) antes de importar os alunos.
                </p>
                <ActionButton
                  onClick={() => setStep(4)}
                  disabled={preview.length === 0}
                  loading={false}
                  icon={Eye}
                >
                  Analisar Estrutura
                </ActionButton>
              </div>
            </div>
          </StepCard>
        )}

        {/* Passo 4: Backfill Acadêmico */}
        {step >= 4 && escolaId && importId && (
          <StepCard
            stepNumber={4}
            title="Estrutura Acadêmica"
            description="Crie sessões, classes, cursos e turmas automaticamente a partir do ficheiro."
          >
            <BackfillStep
              importId={importId}
              escolaId={escolaId}
              onBack={() => setStep(3)}
              onNext={() => setStep(5)}
            />
          </StepCard>
        )}

        {/* Passo 5: Importação */}
        {step >= 5 && (
          <StepCard
            stepNumber={5}
            title="Importação de Alunos"
            description="Crie/atualize os alunos na escola a partir dos dados validados."
          >
            <div className="space-y-4">
              <div className="flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
                <p className="text-[11px] text-slate-500">
                  Ao confirmar, os alunos serão criados/atualizados. Depois poderá matricular em massa.
                </p>
                <ActionButton
                  onClick={handleImport}
                  disabled={!importId || !escolaId}
                  loading={loading && step === 5}
                  icon={CheckCircle}
                >
                  Confirmar importação
                </ActionButton>
              </div>
            </div>
          </StepCard>
        )}

        {/* Passo 6: Revisão de Matrícula */}
        {step >= 6 && (
          <StepCard
            stepNumber={6}
            title="Revisão de Matrícula"
            description="Revise os grupos por turma detectados e confirme a matrícula em massa para cada turma."
          >
            <div className="space-y-4">
              {matriculaBatches.length === 0 ? (
                <p className="text-sm text-slate-500">Nenhum grupo encontrado para este ficheiro.</p>
              ) : (
                <div className="border rounded-lg divide-y">
                  {matriculaBatches.map((b: any, idx: number) => (
                    <div key={idx} className="p-3 flex items-center justify-between gap-3">
                      <div className="flex items-center gap-3">
                        <input
                          type="checkbox"
                          checked={!!selectedBatches[idx]}
                          onChange={(e) => setSelectedBatches({ ...selectedBatches, [idx]: e.target.checked })}
                        />
                        <div>
                          <div className="text-sm font-semibold text-slate-800 flex items-center gap-2">
                            {b.turma_nome}
                            {b.turma_codigo && (
                              <span className="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 border border-slate-200">{b.turma_codigo}</span>
                            )}
                            {b.ano_letivo && (
                              <span className="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 border border-slate-200">{b.ano_letivo}</span>
                            )}
                          </div>
                          <div className="text-xs text-slate-500">Código {b.turma_codigo || '—'} • {b.total_alunos} aluno(s) • {b.status === 'ready' ? 'Pronto' : 'Sem turma correspondente'}</div>
                        </div>
                      </div>
                      <div className="text-xs font-medium {b.status==='ready' ? 'text-emerald-700' : 'text-amber-700'}">
                        {b.status === 'ready' ? 'OK' : 'Atenção'}
                      </div>
                    </div>
                  ))}
                </div>
              )}
              {matriculando && (
                <div className="w-full bg-slate-100 rounded h-2 overflow-hidden">
                  <div className="bg-emerald-600 h-2 transition-all" style={{ width: `${progressTotal>0 ? Math.round((progressDone/progressTotal)*100) : 0}%` }} />
                  <div className="mt-1 text-[11px] text-slate-500">A matricular {progressDone} de {progressTotal} turmas…</div>
                </div>
              )}
              <div className="flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
                <p className="text-[11px] text-slate-500">Os grupos marcados serão matriculados, um a um, com progresso visível.</p>
                <ActionButton
                  onClick={async () => {
                    if (!importId || !escolaId) return;
                    setMatriculando(true);
                    setProgressDone(0);
                    setMatriculaSummary([]);
                    try {
                        const toRun = matriculaBatches
                          .map((b: any, idx: number) => ({ b, idx }))
                          .filter(({ idx }) => selectedBatches[idx])
                          .filter(({ b }) => b.status === 'ready' && b.turma_id);
                        setProgressTotal(toRun.length);
                        let done = 0;
                        for (const { b } of toRun) {
                        // Chama endpoint por turma (RPC no banco)
                        const turmaCode = (b.turma_codigo || '').toString().trim().toUpperCase();
                        const payload = {
                          import_id: importId,
                          escola_id: escolaId,
                          turma_id: b.turma_id,
                          turma_code: turmaCode || undefined,
                          ano_letivo: b.ano_letivo ?? anoLetivo,
                        };
                        const res = await fetch('/api/matriculas/massa/por-turma', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify(payload),
                        });
                        let success = 0, errors = 0;
                        try {
                          const json = await res.json();
                          if (res.ok && json?.ok) {
                            success = Number(json.success_count || 0);
                            errors = Number(json.error_count || 0);
                          }
                        } catch {}
                        setMatriculaSummary(prev => ([...prev, { turma_nome: b.turma_nome, turma_id: b.turma_id, success, errors }]));
                        done++;
                        setProgressDone(done);
                      }
                      setStep(7);
                    } finally {
                      setMatriculando(false);
                    }
                  }}
                  disabled={matriculaBatches.length === 0}
                  loading={matriculando}
                  icon={CheckCircle}
                  >
                    Confirmar e Matricular
                </ActionButton>
                <button
                  onClick={async () => { await fetchMatriculaPreview(); }}
                  className="inline-flex items-center justify-center rounded-lg px-3 py-2 text-xs font-medium text-slate-700 bg-slate-100 hover:bg-slate-200"
                >
                  Recarregar análise
                </button>
              </div>
            </div>
          </StepCard>
        )}

        {/* Passo 7: Finalização */}
        {step >= 7 && (
          <StepCard
            stepNumber={7}
            title="Importação concluída"
            description="Veja o resumo da importação e trate eventuais erros."
          >
            <div className="space-y-5">
              <ResultsSummary />
              {(importResult?.turmas_created ?? 0) > 0 && (
                <div className="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-3">
                  <div className="text-amber-600 mt-1">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>

                  <div className="flex-1">
                    <h4 className="text-sm font-bold text-amber-800">
                      Atenção: {importResult?.turmas_created} novas turmas foram criadas automaticamente!
                    </h4>
                    <p className="text-sm text-amber-700 mt-1">
                      O sistema detectou códigos de turma no CSV que não existiam no banco.
                      Para não bloquear a importação, criamos estas turmas como <strong>Rascunho</strong>.
                    </p>

                    <div className="mt-3">
                      <a
                        href="/secretaria/turmas?status=rascunho"
                        className="text-sm font-medium text-amber-800 underline hover:text-amber-900"
                      >
                        Ir para Turmas e validar preços/cursos &rarr;
                      </a>
                    </div>
                  </div>
                </div>
              )}
              {matriculaSummary.length > 0 && (
                <div className="space-y-2">
                  <div className="text-sm font-semibold text-slate-900">Resumo das matrículas por turma</div>
                  <div className="rounded-md border border-slate-200 overflow-hidden">
                    <table className="w-full text-sm">
                      <thead className="bg-slate-50">
                        <tr>
                          <th className="text-left px-3 py-2 text-slate-600 font-medium">Turma</th>
                          <th className="text-right px-3 py-2 text-slate-600 font-medium">Inseridos</th>
                          <th className="text-right px-3 py-2 text-slate-600 font-medium">Erros</th>
                        </tr>
                      </thead>
                      <tbody>
                        {matriculaSummary.map((it, i) => (
                          <tr key={i} className="border-t border-slate-100">
                            <td className="px-3 py-2">{it.turma_nome}</td>
                            <td className="px-3 py-2 text-right text-emerald-700 font-medium">{it.success}</td>
                            <td className="px-3 py-2 text-right text-red-600">{it.errors}</td>
                          </tr>
                        ))}
                        <tr className="border-t border-slate-200 bg-slate-50">
                          <td className="px-3 py-2 font-semibold">Totais</td>
                          <td className="px-3 py-2 text-right font-semibold text-emerald-800">{matriculaSummary.reduce((a, b) => a + b.success, 0)}</td>
                          <td className="px-3 py-2 text-right font-semibold text-red-700">{matriculaSummary.reduce((a, b) => a + b.errors, 0)}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {importErrors.length > 0 && (
                <div className="space-y-3">
                  <div className="flex items-center justify-between gap-3">
                    <span className="text-sm font-medium text-slate-900">
                      Registos com erro
                    </span>
                    <button
                      className="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50"
                    >
                      <Download className="h-4 w-4" />
                      Baixar relatório
                    </button>
                  </div>
                  <p className="text-[11px] text-slate-500">
                    Corrija estes registos no ficheiro de origem e faça uma nova importação apenas dos casos em erro,
                    se necessário.
                  </p>
                  <ErrorList errors={importErrors} />
                </div>
              )}

              <div className="rounded-lg border border-slate-100 bg-slate-50/60 px-3 py-2.5 text-[11px] text-slate-600 space-y-1.5">
                <div className="flex items-center gap-2 font-medium text-slate-700">
                  <Info className="h-3.5 w-3.5" />
                  <span>Próximos passos sugeridos</span>
                </div>
                <ul className="pl-5 list-disc space-y-0.5">
                  <li>Conferir os alunos importados em <strong>/secretaria/alunos</strong>.</li>
                  <li>Usar a funcionalidade de <strong>Matrículas em Massa</strong> (quando ativada) para colocar os alunos nas turmas.</li>
                </ul>
              </div>

              <div className="flex flex-col sm:flex-row gap-3 pt-4 border-t border-slate-100">
                <a
                  href="/secretaria/matriculas"
                  className="w-full sm:w-auto inline-flex items-center justify-center rounded-lg px-4 py-2.5 text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 transition-colors"
                >
                  Ir para Matrículas
                </a>
                <a
                  href="/secretaria/rematricula"
                  className="w-full sm:w-auto inline-flex items-center justify-center rounded-lg px-4 py-2.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors"
                >
                  Ir para Rematrícula
                </a>
                <ActionButton onClick={resetWizard} icon={RefreshCw}>
                  Nova importação
                </ActionButton>

                <button
                  onClick={() => window.history.back()}
                  className="w-full sm:w-auto inline-flex items-center justify-center rounded-lg px-4 py-2.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 transition-colors"
                >
                  Voltar ao painel
                </button>
              </div>
            </div>
          </StepCard>
        )}
      </div>
    </div>
  );
}
