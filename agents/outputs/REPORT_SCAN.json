{
  "timestamp": "2026-01-21T08:31:50.832Z",
  "repoRoot": "/Users/gundja/moxi-edtech",
  "summary": {
    "critical": 0,
    "high": 1,
    "medium": 0,
    "low": 6,
    "total": 7
  },
  "findings": [
    {
      "id": "NO_STORE",
      "title": "Anti-pattern — uso de cache: 'no-store' em páginas/relatórios",
      "severity": "HIGH",
      "status": "PARTIAL",
      "evidence": [
        {
          "file": "apps/web/src/app/financeiro/page.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/secretaria/MatriculasListClient.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/secretaria/TurmaForm.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/app/escola/[id]/financeiro/page.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        }
      ],
      "recommendation": "Remover no-store onde houver MV/camadas cacheáveis; manter só em rotas realmente sensíveis."
    },
    {
      "id": "KF2",
      "title": "KF2 — Pesquisa Global (Command Palette) invariants",
      "severity": "LOW",
      "status": "VALIDATED",
      "evidence": [
        {
          "file": "apps/web/src/components/GlobalSearch.tsx",
          "note": "debounce detectado (hook/client): sim"
        },
        {
          "file": "apps/web/src/hooks/useGlobalSearch.ts",
          "note": "rpc min: sim"
        },
        {
          "file": "apps/web/src/hooks/useGlobalSearch.ts",
          "note": "limit clamp <= 50: sim"
        },
        {
          "file": "supabase/migrations",
          "note": "ORDER BY id DESC: sim"
        },
        {
          "file": "apps/web/src/hooks/useGlobalSearch.ts",
          "note": "useGlobalSearch encontrado"
        }
      ],
      "recommendation": "KF2 deve ter debounce 250–400ms, limit<=50, orderBy estável e payload mínimo."
    },
    {
      "id": "GF4",
      "title": "GF4 — Audit Trail (parcial/validar cobertura before/after)",
      "severity": "LOW",
      "status": "VALIDATED",
      "evidence": [
        {
          "file": "DOUBLE_CHECK_REPORT_ADMISSAO_P0_V2.md",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "E2E_CHECKLIST_ADMISSAO.md",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "MIGRATION_ADMISSAO_P0.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "REPORT_ADMISSAO_P0.md",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "types/database.ts",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "types/supabase.ts",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20251231163837_baseline.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20251231200952_remote_schema.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20261017000000_create_hard_delete_curso_rpc.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20261019002000_audit_trail_hardening.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20261019008000_audit_schema_min.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20261019009500_audit_actor_role.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20261019104000_gf4_audit_hardening.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20261019108000_hard_delete_aluno_rpc.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20261019150000_finance_payment_intents.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20261019151000_finance_confirm_payment_patch.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20261019170000_create_admissao_rpcs.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/functions/outbox-worker/index.ts",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations_archive/migrations_backup/20250917060400_audit_redaction.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations_archive/migrations_backup/20250917060500_audit_triggers.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations_archive/migrations_backup/20250917060600_audit_user_default.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations_archive/migrations_backup/20250917060700_create_audit_logs.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations_archive/migrations_backup/20251108141000_fix_rls_initplan_policies.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations_archive/migrations/20250915000000_remote_schema.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations_archive/migrations/20250917060400_audit_redaction.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        }
      ],
      "recommendation": "Padronizar schema: actor, action, entity, before, after, ip, created_at; garantir coverage financeiro/matrícula."
    },
    {
      "id": "F09_MV",
      "title": "F09 — Radar de Inadimplência com MATERIALIZED VIEW",
      "severity": "LOW",
      "status": "VALIDATED",
      "evidence": [
        {
          "file": "supabase/migrations/20260109_000001_mv_financeiro_dashboards.sql",
          "note": "match: /CREATE\\s+MATERIALIZED\\s+VIEW\\s+public\\.mv_radar_inadimplencia/i"
        },
        {
          "file": "supabase/migrations/20260109_000001_mv_financeiro_dashboards.sql",
          "note": "match: /CREATE\\s+UNIQUE\\s+INDEX\\s+.*ux_mv_radar_inadimplencia/i"
        },
        {
          "file": "supabase/migrations/20260109_000001_mv_financeiro_dashboards.sql",
          "note": "match: /refresh_mv_radar_inadimplencia\\s*\\(/i"
        },
        {
          "file": "supabase/migrations/20261019003000_mv_admin_secretaria_dashboards.sql",
          "note": "match: /refresh_mv_radar_inadimplencia\\s*\\(/i"
        },
        {
          "file": "supabase/migrations/20261019150000_finance_payment_intents.sql",
          "note": "match: /refresh_mv_radar_inadimplencia\\s*\\(/i"
        },
        {
          "file": "supabase/migrations/20260109_000001_mv_financeiro_dashboards.sql",
          "note": "match: /CREATE\\s+OR\\s+REPLACE\\s+VIEW\\s+public\\.vw_radar_inadimplencia/i"
        },
        {
          "file": "supabase/migrations_archive/migrations/20251120100000_create_financial_module.sql",
          "note": "match: /CREATE\\s+OR\\s+REPLACE\\s+VIEW\\s+public\\.vw_radar_inadimplencia/i"
        },
        {
          "file": "supabase/migrations_archive/migrations/20251123230000_replace_vw_radar_inadimplencia.sql",
          "note": "match: /CREATE\\s+OR\\s+REPLACE\\s+VIEW\\s+public\\.vw_radar_inadimplencia/i"
        }
      ],
      "recommendation": "Garantir MV + UNIQUE INDEX + refresh function + cron job + view wrapper."
    },
    {
      "id": "F18_MV",
      "title": "F18 — Caixa/Propinas com MATERIALIZED VIEW",
      "severity": "LOW",
      "status": "VALIDATED",
      "evidence": [
        {
          "file": "supabase/migrations/20260109_000001_mv_financeiro_dashboards.sql",
          "note": "match: /CREATE\\s+MATERIALIZED\\s+VIEW\\s+public\\.mv_pagamentos_status/i"
        },
        {
          "file": "supabase/migrations/20260109_000001_mv_financeiro_dashboards.sql",
          "note": "match: /CREATE\\s+UNIQUE\\s+INDEX\\s+.*ux_mv_pagamentos_status/i"
        },
        {
          "file": "supabase/migrations/20260109_000001_mv_financeiro_dashboards.sql",
          "note": "match: /refresh_mv_pagamentos_status\\s*\\(/i"
        },
        {
          "file": "supabase/migrations/20261019003000_mv_admin_secretaria_dashboards.sql",
          "note": "match: /refresh_mv_pagamentos_status\\s*\\(/i"
        },
        {
          "file": "supabase/migrations/20261019150000_finance_payment_intents.sql",
          "note": "match: /refresh_mv_pagamentos_status\\s*\\(/i"
        },
        {
          "file": "supabase/migrations/20260109_000001_mv_financeiro_dashboards.sql",
          "note": "match: /CREATE\\s+OR\\s+REPLACE\\s+VIEW\\s+public\\.pagamentos_status/i"
        },
        {
          "file": "supabase/migrations_archive/migrations_backup/20250916000100_create_views.sql",
          "note": "match: /CREATE\\s+OR\\s+REPLACE\\s+VIEW\\s+public\\.pagamentos_status/i"
        },
        {
          "file": "supabase/migrations_archive/migrations/20250916000100_create_views.sql",
          "note": "match: /CREATE\\s+OR\\s+REPLACE\\s+VIEW\\s+public\\.pagamentos_status/i"
        }
      ],
      "recommendation": "Garantir MV + UNIQUE INDEX + refresh function + cron job + view wrapper."
    },
    {
      "id": "P0_3_MV_DASHBOARDS",
      "title": "P0.3 — Dashboards Secretaria/Admin em MATERIALIZED VIEW",
      "severity": "LOW",
      "status": "VALIDATED",
      "evidence": [
        {
          "file": "supabase/migrations/20261019003000_mv_admin_secretaria_dashboards.sql",
          "note": "match: /mv_secretaria_dashboard_counts/i"
        },
        {
          "file": "supabase/migrations/20261019003000_mv_admin_secretaria_dashboards.sql",
          "note": "match: /ux_mv_secretaria_dashboard_counts/i"
        },
        {
          "file": "supabase/migrations/20261019003000_mv_admin_secretaria_dashboards.sql",
          "note": "match: /refresh_mv_secretaria_dashboard_counts/i"
        },
        {
          "file": "supabase/migrations/20261019003000_mv_admin_secretaria_dashboards.sql",
          "note": "match: /vw_secretaria_dashboard_counts/i"
        },
        {
          "file": "supabase/migrations/20261019003000_mv_admin_secretaria_dashboards.sql",
          "note": "match: /cron\\.schedule\\(['\"]refresh_mv_secretaria_dashboard_counts['\"]/i"
        },
        {
          "file": "supabase/migrations/20261019003000_mv_admin_secretaria_dashboards.sql",
          "note": "match: /mv_secretaria_matriculas_status/i"
        },
        {
          "file": "supabase/migrations/20261019003000_mv_admin_secretaria_dashboards.sql",
          "note": "match: /ux_mv_secretaria_matriculas_status/i"
        },
        {
          "file": "supabase/migrations/20261019003000_mv_admin_secretaria_dashboards.sql",
          "note": "match: /refresh_mv_secretaria_matriculas_status/i"
        },
        {
          "file": "supabase/migrations/20261019003000_mv_admin_secretaria_dashboards.sql",
          "note": "match: /vw_secretaria_matriculas_status/i"
        },
        {
          "file": "supabase/migrations/20261019003000_mv_admin_secretaria_dashboards.sql",
          "note": "match: /cron\\.schedule\\(['\"]refresh_mv_secretaria_matriculas_status['\"]/i"
        }
      ],
      "recommendation": "Garantir MV + UNIQUE INDEX + refresh function + cron job + view wrapper para secretária e admin (sem cálculo ao vivo)."
    },
    {
      "id": "PLAN_GUARD",
      "title": "P0.3 — Controle de planos (backend + UI)",
      "severity": "LOW",
      "status": "VALIDATED",
      "evidence": [
        {
          "file": "apps/web/src/app/api/financeiro/recibos/emitir/route.ts",
          "note": "backend guard (fin_recibo_pdf): sim"
        },
        {
          "file": "apps/web/src/app/api/financeiro/extrato/aluno/[alunoId]/pdf/route.ts",
          "note": "backend guard (doc_qr_code): sim"
        },
        {
          "file": "apps/web/src/app/api/secretaria/turmas/[id]/alunos/pdf/route.ts",
          "note": "backend guard (doc_qr_code): sim"
        },
        {
          "file": "apps/web/src/app/api/secretaria/turmas/[id]/alunos/lista/route.ts",
          "note": "backend guard (doc_qr_code): sim"
        },
        {
          "file": "apps/web/src/components/financeiro/ReciboImprimivel.tsx",
          "note": "ui guard (fin_recibo_pdf): sim"
        },
        {
          "file": "apps/web/src/components/financeiro/ExtratoActions.tsx",
          "note": "ui guard (doc_qr_code): sim"
        },
        {
          "file": "apps/web/src/components/secretaria/TurmaDetailClient.tsx",
          "note": "ui guard (doc_qr_code): sim"
        }
      ],
      "recommendation": "Garantir requireFeature em rotas premium e usePlanFeature em entrypoints UI."
    }
  ]
}