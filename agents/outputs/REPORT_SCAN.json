{
  "timestamp": "2026-02-24T00:01:48.957Z",
  "repoRoot": "/Users/gundja/moxi-edtech",
  "summary": {
    "critical": 0,
    "high": 4,
    "medium": 0,
    "low": 3,
    "total": 7
  },
  "findings": [
    {
      "id": "NO_STORE",
      "title": "Anti-pattern — uso de cache: 'no-store' em páginas/relatórios",
      "severity": "HIGH",
      "status": "PARTIAL",
      "evidence": [
        {
          "file": "tools/validator/fluency-validator-monorepo.js",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/hooks/useMatriculaLogic.ts",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/lib/auth-admin-job.ts",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/app/financeiro/page.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/app/professor/page.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/financeiro/GerarMensalidadesModal.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/financeiro/MissingPricingAlert.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/secretaria/BalcaoAtendimento.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/secretaria/BuscaBalcaoRapido.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/secretaria/DocumentosEmissaoHubClient.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/secretaria/DocumentosOficiaisBatchClient.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/secretaria/FilaAtendimentoModal.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/secretaria/ImportacoesListClient.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/secretaria/MatriculasListClient.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/secretaria/ModalPagamentoRapido.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/secretaria/PagamentoModal.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/secretaria/PautaRapidaModal.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/secretaria/TurmaDetailClient.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/app/financeiro/_components/RadarInadimplenciaActive.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/app/financeiro/fecho/page.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/app/professor/frequencias/page.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/app/professor/notas/page.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/app/professor/perfil/page.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/app/secretaria/(portal-secretaria)/page.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        },
        {
          "file": "apps/web/src/components/aluno/dashboard/DashboardLoader.tsx",
          "note": "match: /cache:\\s*['\\\"]no-store['\\\"]/i"
        }
      ],
      "recommendation": "Remover no-store onde houver MV/camadas cacheáveis; manter só em rotas realmente sensíveis."
    },
    {
      "id": "KF2",
      "title": "KF2 — Pesquisa Global (Command Palette) invariants",
      "severity": "LOW",
      "status": "VALIDATED",
      "evidence": [
        {
          "file": "apps/web/src/components/GlobalSearch.tsx",
          "note": "debounce detectado (hook/client): sim"
        },
        {
          "file": "apps/web/src/hooks/useGlobalSearch.ts",
          "note": "rpc min: sim"
        },
        {
          "file": "apps/web/src/hooks/useGlobalSearch.ts",
          "note": "limit clamp <= 50: sim"
        },
        {
          "file": "supabase/migrations",
          "note": "ORDER BY id DESC: sim"
        },
        {
          "file": "apps/web/src/hooks/useGlobalSearch.ts",
          "note": "useGlobalSearch encontrado"
        }
      ],
      "recommendation": "KF2 deve ter debounce 250–400ms, limit<=50, orderBy estável e payload mínimo."
    },
    {
      "id": "GF4",
      "title": "GF4 — Audit Trail (parcial/validar cobertura before/after)",
      "severity": "LOW",
      "status": "VALIDATED",
      "evidence": [
        {
          "file": "temp_supabase_output.ts",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "types/database.ts",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "types/supabase.ts",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "tools/validator/fluency-validator-monorepo.js",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260127020700_admin_get_escola_health_metrics_rpc.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260127140000_create_confirmar_conciliacao_transacao_rpc.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260202000000_klasse_p0_compliance_fixes.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260202002000_sync_lancamentos_registrar_pagamento.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260202003000_set_created_by_on_paid_lancamentos.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000000_rpc_setup_active_ano_letivo.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000002_rpc_upsert_bulk_periodos_letivos.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000003_add_audit_to_curriculo_publish.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000004_rpc_gerar_turmas_from_curriculo.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000005_rpc_onboard_academic_structure.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000006_refactor_frequencia_ssot.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000007_rpc_lancar_notas_batch.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000009_rpc_fechar_periodo_unificado.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000010_rpc_transferir_matricula.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000011_rpc_finalizar_matricula.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000012_rpc_gerar_historico_anual.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000013_update_finalizar_matricula_rpc.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000015_refactor_gerar_mensalidades_trigger.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000016_add_audit_to_finance_rpcs.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        },
        {
          "file": "supabase/migrations/20260203000018_rpc_conciliar_transacoes_auto_match.sql",
          "note": "match: /audit_logs|auditLog|create_audit/i"
        }
      ],
      "recommendation": "Padronizar schema: actor, action, entity, before, after, ip, created_at; garantir coverage financeiro/matrícula."
    },
    {
      "id": "F09_MV",
      "title": "F09 — Radar de Inadimplência com MATERIALIZED VIEW",
      "severity": "HIGH",
      "status": "PARTIAL",
      "evidence": [
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /CREATE\\s+UNIQUE\\s+INDEX\\s+.*ux_mv_radar_inadimplencia/i"
        },
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /refresh_mv_radar_inadimplencia\\s*\\(/i"
        },
        {
          "file": "supabase/migrations_archive/migrations/20251120100000_create_financial_module.sql",
          "note": "match: /CREATE\\s+OR\\s+REPLACE\\s+VIEW\\s+public\\.vw_radar_inadimplencia/i"
        },
        {
          "file": "supabase/migrations_archive/migrations/20251123230000_replace_vw_radar_inadimplencia.sql",
          "note": "match: /CREATE\\s+OR\\s+REPLACE\\s+VIEW\\s+public\\.vw_radar_inadimplencia/i"
        },
        {
          "file": "supabase/migrations_archive/migrations/20251124133000_align_financeiro_schema.sql",
          "note": "match: /CREATE\\s+OR\\s+REPLACE\\s+VIEW\\s+public\\.vw_radar_inadimplencia/i"
        }
      ],
      "recommendation": "Garantir MV + UNIQUE INDEX + refresh function + cron job + view wrapper."
    },
    {
      "id": "F18_MV",
      "title": "F18 — Caixa/Propinas com MATERIALIZED VIEW",
      "severity": "HIGH",
      "status": "PARTIAL",
      "evidence": [
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /CREATE\\s+UNIQUE\\s+INDEX\\s+.*ux_mv_pagamentos_status/i"
        },
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /refresh_mv_pagamentos_status\\s*\\(/i"
        },
        {
          "file": "supabase/migrations/20260202010300_fix_pagamentos_status_refresh.sql",
          "note": "match: /refresh_mv_pagamentos_status\\s*\\(/i"
        },
        {
          "file": "supabase/migrations_archive/migrations_backup/20250916000100_create_views.sql",
          "note": "match: /CREATE\\s+OR\\s+REPLACE\\s+VIEW\\s+public\\.pagamentos_status/i"
        },
        {
          "file": "supabase/migrations_archive/migrations/20250916000100_create_views.sql",
          "note": "match: /CREATE\\s+OR\\s+REPLACE\\s+VIEW\\s+public\\.pagamentos_status/i"
        },
        {
          "file": "supabase/migrations_archive/migrations_backup/migrations/20250916000100_create_views.sql",
          "note": "match: /CREATE\\s+OR\\s+REPLACE\\s+VIEW\\s+public\\.pagamentos_status/i"
        }
      ],
      "recommendation": "Garantir MV + UNIQUE INDEX + refresh function + cron job + view wrapper."
    },
    {
      "id": "P0_3_MV_DASHBOARDS",
      "title": "P0.3 — Dashboards Secretaria/Admin em MATERIALIZED VIEW",
      "severity": "HIGH",
      "status": "PARTIAL",
      "evidence": [
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /mv_secretaria_dashboard_counts/i"
        },
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /ux_mv_secretaria_dashboard_counts/i"
        },
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /refresh_mv_secretaria_dashboard_counts/i"
        },
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /vw_secretaria_dashboard_counts/i"
        },
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /mv_secretaria_matriculas_status/i"
        },
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /ux_mv_secretaria_matriculas_status/i"
        },
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /refresh_mv_secretaria_matriculas_status/i"
        },
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /vw_secretaria_matriculas_status/i"
        },
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /mv_secretaria_matriculas_turma_status/i"
        },
        {
          "file": "supabase/migrations/20260127020139_remote_schema.sql",
          "note": "match: /ux_mv_secretaria_matriculas_turma_status/i"
        }
      ],
      "recommendation": "Garantir MV + UNIQUE INDEX + refresh function + cron job + view wrapper para secretária e admin (sem cálculo ao vivo)."
    },
    {
      "id": "PLAN_GUARD",
      "title": "P0.3 — Controle de planos (backend + UI)",
      "severity": "LOW",
      "status": "VALIDATED",
      "evidence": [
        {
          "file": "apps/web/src/app/api/financeiro/recibos/emitir/route.ts",
          "note": "backend guard (fin_recibo_pdf): sim"
        },
        {
          "file": "apps/web/src/app/api/financeiro/extrato/aluno/[alunoId]/pdf/route.ts",
          "note": "backend guard (doc_qr_code): sim"
        },
        {
          "file": "apps/web/src/app/api/secretaria/turmas/[id]/alunos/pdf/route.ts",
          "note": "backend guard (doc_qr_code): sim"
        },
        {
          "file": "apps/web/src/app/api/secretaria/turmas/[id]/alunos/lista/route.ts",
          "note": "backend guard (doc_qr_code): sim"
        },
        {
          "file": "apps/web/src/components/financeiro/ReciboImprimivel.tsx",
          "note": "ui guard (fin_recibo_pdf): sim"
        },
        {
          "file": "apps/web/src/components/financeiro/ExtratoActions.tsx",
          "note": "ui guard (doc_qr_code): sim"
        },
        {
          "file": "apps/web/src/components/secretaria/TurmaDetailClient.tsx",
          "note": "ui guard (doc_qr_code): sim"
        }
      ],
      "recommendation": "Garantir requireFeature em rotas premium e usePlanFeature em entrypoints UI."
    }
  ]
}