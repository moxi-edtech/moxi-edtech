{
  "summary": {
    "report_date": "2026-01-10",
    "failing_hard_gates": [
      "P0.1_TENANT_LEAK",
      "P0.3_MATERIALIZED_VIEWS"
    ],
    "counts_by_severity": {
      "CRITICAL": 1,
      "HIGH": 1,
      "MEDIUM": 2,
      "LOW": 0
    },
    "top_5_prs_sugeridos": [
      "Fix: Isolate tenant data by replacing insecure 'escolaId' resolution with 'resolveEscolaIdForUser' helper.",
      "Fix: Implement Materialized View for F18 (Cash/Tuition Report) to prevent live table aggregation.",
      "Fix: Add GIN/trigram indexes to columns used in 'ILIKE' searches (profiles, turmas, etc.).",
      "Refactor: Replace dangerous hardcoded '.limit()' in export routes with paginated streams.",
      "Fix: Ensure actor context is correctly passed and logged for bulk operations like 'gerar_mensalidades_lote'."
    ]
  },
  "findings": [
    {
      "code": "P0.1_TENANT_LEAK",
      "severity": "CRITICAL",
      "status": "FAIL_CRITICAL",
      "description": "Found multiple instances of insecure tenant ID resolution, creating a critical data leak vector between different 'escolas'.",
      "recommendation": "Immediately replace all instances of the insecure pattern with the 'resolveEscolaIdForUser' helper function, which correctly validates user-tenant membership.",
      "autofix_possible": true,
      "evidence": [
        {
          "file": "apps/web/src/components/layout/PortalLayout.tsx",
          "line": 103,
          "snippet": "const { data: prof } = await supabase.from('profiles').select('escola_id').order('created_at', { ascending: false }).limit(1)",
          "rule": "P0.1 - from('profiles')...limit(1) without user scoping"
        },
        {
          "file": "apps/web/src/app/escola/[id]/financeiro/relatorios/page.tsx",
          "line": 12,
          "snippet": "const { data: prof } = await s.from('profiles').select('escola_id').order('created_at', { ascending: false }).limit(1)",
          "rule": "P0.1 - from('profiles')...limit(1) without user scoping"
        }
      ]
    },
    {
      "code": "P0.3_MV_F18",
      "severity": "HIGH",
      "status": "FAIL_CRITICAL",
      "description": "The 'Relat√≥rio de Caixa/Propinas' (F18) does not use a materialized view, performing heavy, real-time aggregations directly on transactional tables. This is a hard-gate failure.",
      "recommendation": "Refactor the feature's data-fetching layer ('/api/financeiro/relatorios/propinas') to query a new, purpose-built materialized view that pre-aggregates monthly tuition data. The existing 'mv_pagamentos_status' is not adequate.",
      "autofix_possible": false,
      "evidence": [
        {
          "file": "apps/web/src/app/api/financeiro/relatorios/propinas/route.ts",
          "line": 24,
          "snippet": ".from(\"vw_financeiro_propinas_mensal_escola\")",
          "rule": "P0.3 - Dashboard must not query a heavy view directly."
        },
        {
          "file": "apps/web/src/app/api/financeiro/relatorios/propinas/route.ts",
          "line": 58,
          "snippet": ".rpc(\"get_propinas_por_turma\", { p_ano_letivo: anoLetivo })",
          "rule": "P0.3 - Dashboard must not call an RPC that aggregates live data."
        }
      ]
    },
    {
      "code": "PERF_PAGINATION",
      "severity": "MEDIUM",
      "status": "MISSING",
      "description": "Data export routes and several list APIs use large, hardcoded limits instead of proper, streamed pagination, creating a high risk of server timeouts and memory exhaustion.",
      "recommendation": "Refactor all export routes to use streaming APIs. Implement standard cursor- or offset-based pagination for all list APIs that currently lack it.",
      "autofix_possible": false,
      "evidence": [
        {
          "file": "app/secretaria/alunos/export/route.ts",
          "line": 33,
          "snippet": ".limit(5000)",
          "rule": "Anti-pattern: endpoint without proper pagination."
        },
        {
          "file": "app/api/financeiro/radar/route.ts",
          "line": 44,
          "snippet": ".limit(5000);",
          "rule": "Anti-pattern: endpoint without proper pagination."
        }
      ]
    },
    {
      "code": "PERF_TRIGRAM_COVERAGE",
      "severity": "MEDIUM",
      "status": "PARTIAL",
      "description": "Trigram indexes for ILIKE searches are not applied to several frequently searched columns, leading to slow full-table scans.",
      "recommendation": "Add GIN/trigram indexes to 'profiles.nome', 'profiles.email', 'turmas.nome', and other text columns used in search filters.",
      "autofix_possible": true,
      "evidence": [
        {
          "file": "apps/web/src/app/api/secretaria/professores/route.ts",
          "line": 100,
          "snippet": "profilesQuery = profilesQuery.or(`nome.ilike.%${q}%,email.ilike.%${q}%...`)",
          "rule": "P0.2 - ILIKE without corresponding trigram index."
        }
      ]
    },
    {
      "code": "P0.2_KF2_INVARIANTS",
      "severity": "LOW",
      "status": "VALIDATED",
      "description": "Global Search (KF2) backend and frontend invariants are met, including debouncing, limit clamping, stable sorting, and use of trigram indexes.",
      "recommendation": "None.",
      "autofix_possible": false,
      "evidence": []
    },
    {
      "code": "P0.4_AUDIT_TRAIL",
      "severity": "LOW",
      "status": "PARTIAL",
      "description": "Audit trail is well-implemented with before/after state and coverage for core financial tables, but actor attribution for bulk operations is weak.",
      "recommendation": "For bulk RPCs like 'gerar_mensalidades_lote', manually pass and log the originating user's ID via 'create_audit_event' instead of relying solely on the DML trigger's 'auth.uid()'.",
      "autofix_possible": true,
      "evidence": [
        {
          "file": "supabase/migrations/20251231163837_baseline.sql",
          "snippet": "CREATE FUNCTION public.gerar_mensalidades_lote(...)",
          "rule": "P0.4 - Bulk operation does not manually log the initiating actor."
        }
      ]
    },
    {
      "code": "P0.5_PLAN_CONTROL",
      "severity": "LOW",
      "status": "VALIDATED",
      "description": "The system for feature-gating based on customer plans is correctly implemented on both the backend (requireFeature) and frontend (usePlanFeature).",
      "recommendation": "None.",
      "autofix_possible": false,
      "evidence": []
    }
  ]
}