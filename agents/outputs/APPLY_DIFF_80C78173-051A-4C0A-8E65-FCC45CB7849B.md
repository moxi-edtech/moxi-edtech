# Diff: reforçar retorno e pendências no import de alunos

```diff
*** Update File: apps/web/src/app/api/migracao/alunos/importar/route.ts
@@
-export const dynamic = "force-dynamic";
+export const dynamic = "force-dynamic";
+
+type FinancePendenciaMotivo =
+  | "turma_nao_encontrada"
+  | "turma_inativa"
+  | "matricula_pendente"
+  | "pricing_ausente";
+
+type FinancePendenciaItem = {
+  codigo: FinancePendenciaMotivo;
+  motivo: string;
+  mensagem: string;
+  aluno_id: string | null;
+  aluno_nome: string | null;
+  matricula_id: string | null;
+  turma_id: string | null;
+  turma_codigo: string | null;
+};
+
+type FinanceContextResult = {
+  activeMatriculas: number;
+  pendencias: FinancePendenciaItem[];
+};
+
+const pendenciaCatalogo: Record<FinancePendenciaMotivo, { motivo: string; mensagem: string }> = {
+  turma_nao_encontrada: {
+    motivo: "Turma não encontrada",
+    mensagem: "A turma indicada não está cadastrada ou não foi reconhecida.",
+  },
+  turma_inativa: {
+    motivo: "Turma não ativa",
+    mensagem: "A turma ainda não está ativa. A coordenação precisa aprovar.",
+  },
+  matricula_pendente: {
+    motivo: "Matrícula pendente",
+    mensagem: "A matrícula ainda não foi confirmada para esta turma.",
+  },
+  pricing_ausente: {
+    motivo: "Preço não configurado",
+    mensagem: "Configure a tabela de preços para gerar o financeiro.",
+  },
+};
@@
-  let financeActiveCount = 0;
-  try {
+  let financeResult: FinanceContextResult = { activeMatriculas: 0, pendencias: [] };
+  let financeErrorMessage: string | null = null;
+  try {
@@
-    financeActiveCount = await aplicarContextoFinanceiro({
+    financeResult = await aplicarContextoFinanceiro({
       supabase,
       escolaId,
       importId,
       anoLetivo: anoLetivoFromStaging,
       skipMatricula,
       startMonth,
     });
   } catch (financeError) {
     console.error("[migracao/importar] Falha ao aplicar contexto financeiro:", financeError);
+    financeErrorMessage = "Não foi possível aplicar o financeiro automaticamente.";
   }
+
+  const pendenciasFinanceiras = financeResult.pendencias ?? [];
+  const pendenciasVisiveis = pendenciasFinanceiras.map(({ codigo, ...rest }) => rest);
+  const pendenciasPorMotivo = pendenciasFinanceiras.reduce<Record<string, number>>((acc, item) => {
+    acc[item.motivo] = (acc[item.motivo] ?? 0) + 1;
+    return acc;
+  }, {});
+
+  const pendenciasTotal = pendenciasFinanceiras.length;
+  const okFinanceiro = !financeErrorMessage && pendenciasTotal === 0;
+
+  const mensagemResumo = pendenciasTotal > 0
+    ? `Importação concluída: ${result.imported} importados, ${pendenciasTotal} com pendências financeiras.`
+    : `Importação concluída: ${result.imported} importados sem pendências financeiras.`;
+
+  try {
+    const { error: clearPendenciasErr } = await supabase
+      .from("import_financeiro_pendencias")
+      .delete()
+      .eq("import_id", importId);
+
+    if (clearPendenciasErr) {
+      console.error("[import_financeiro_pendencias] clear error", clearPendenciasErr);
+    }
+
+    if (pendenciasFinanceiras.length > 0) {
+      const pendenciasRows = pendenciasFinanceiras.map((item) => ({
+        escola_id: escolaId,
+        import_id: importId,
+        aluno_id: item.aluno_id,
+        matricula_id: item.matricula_id,
+        turma_id: item.turma_id,
+        motivo: item.motivo,
+        mensagem: item.mensagem,
+        detalhes: {
+          codigo: item.codigo,
+          turma_codigo: item.turma_codigo,
+        },
+      }));
+
+      const { error: insertPendenciasErr } = await supabase
+        .from("import_financeiro_pendencias")
+        .insert(pendenciasRows);
+
+      if (insertPendenciasErr) {
+        console.error("[import_financeiro_pendencias] insert error", insertPendenciasErr);
+      }
+    }
+  } catch (pendenciasError) {
+    console.error("[import_financeiro_pendencias] inesperado", pendenciasError);
+  }
@@
     await notificarRascunhosESucesso({
       supabase,
       escolaId,
       importId,
       result,
-      activeMatriculas: financeActiveCount,
+      activeMatriculas: financeResult.activeMatriculas,
     });
   } catch (notifyError) {
     console.error("[migracao/importar] Falha ao notificar:", notifyError);
   }
-
-  return NextResponse.json(result ?? {});
+
+  return NextResponse.json({
+    ok: result.ok,
+    ok_importacao: result.ok,
+    ok_financeiro: okFinanceiro,
+    mensagem_resumo: mensagemResumo,
+    resumo: {
+      importados: result.imported,
+      erros: result.errors,
+      turmas_criadas: result.turmas_created ?? 0,
+      matriculas_pendentes: result.matriculas_pendentes ?? 0,
+      financeiro_ativo: financeResult.activeMatriculas,
+      pendencias_financeiras: pendenciasTotal,
+    },
+    pendencias_financeiras: {
+      total: pendenciasTotal,
+      por_motivo: pendenciasPorMotivo,
+      itens: pendenciasVisiveis,
+    },
+    alertas: financeErrorMessage ? [financeErrorMessage] : [],
+    result,
+  });
 }
@@
-}): Promise<number> {
+}): Promise<FinanceContextResult> {
@@
-  const { data: matriculas } = await supabase
-    .from("matriculas")
-    .select("id, aluno_id, turma_id, ano_letivo, turmas(id, curso_id, classe_id, status_validacao)")
-    .in("aluno_id", alunoIds)
-    .eq("ano_letivo", anoLetivo);
+  const { data: matriculas } = await supabase
+    .from("matriculas")
+    .select(
+      "id, aluno_id, turma_id, ano_letivo, status, ativo, turmas(id, curso_id, classe_id, status_validacao, turma_codigo, nome), alunos(nome, nome_completo)"
+    )
+    .in("aluno_id", alunoIds)
+    .eq("ano_letivo", anoLetivo);
@@
-  const matriculasValidas: Array<{ id: string; aluno_id: string; turma_id: string | null; pricing: { valorMatricula: number; valorMensalidade: number; diaVencimento: number | null } }>
+  const pendencias: FinancePendenciaItem[] = [];
+
+  const matriculasValidas: Array<{ id: string; aluno_id: string; turma_id: string | null; pricing: { valorMatricula: number; valorMensalidade: number; diaVencimento: number | null } }>
     = [];
@@
-  for (const m of matriculas || []) {
-    const turma = (m as any).turmas as any;
-    if (!turma || turma.status_validacao !== "ativo") continue;
-    const pricing = await resolvePricing(turma.curso_id, turma.classe_id);
-    if (!pricing) continue;
-    matriculasValidas.push({
-      id: (m as any).id,
-      aluno_id: (m as any).aluno_id,
-      turma_id: (m as any).turma_id,
-      pricing,
-    });
-  }
-
-  const alunoMensalidade = new Set<string>();
-  const matriculasParaAbono = new Set<string>();
-
-  for (const m of matriculasValidas) {
-    if (m.pricing.valorMensalidade > 0) alunoMensalidade.add(m.aluno_id);
-    if (skipMatricula && m.pricing.valorMatricula > 0) matriculasParaAbono.add(m.id);
-  }
+  const pushPendencia = (
+    m: any,
+    turma: any,
+    motivo: FinancePendenciaMotivo
+  ) => {
+    const catalogo = pendenciaCatalogo[motivo];
+    const alunoNome = (m?.alunos?.nome_completo ?? m?.alunos?.nome ?? null) as string | null;
+    const turmaCodigo = (turma?.turma_codigo ?? turma?.nome ?? null) as string | null;
+    pendencias.push({
+      codigo: motivo,
+      motivo: catalogo.motivo,
+      mensagem: catalogo.mensagem,
+      aluno_id: m?.aluno_id ?? null,
+      aluno_nome: alunoNome,
+      matricula_id: m?.id ?? null,
+      turma_id: m?.turma_id ?? null,
+      turma_codigo: turmaCodigo,
+    });
+  };
+
+  for (const m of matriculas || []) {
+    const turma = (m as any).turmas as any;
+    if (!turma) {
+      pushPendencia(m, null, "turma_nao_encontrada");
+      continue;
+    }
+    if (turma.status_validacao !== "ativo") {
+      pushPendencia(m, turma, "turma_inativa");
+      continue;
+    }
+    const statusMatricula = String((m as any).status || "").toLowerCase();
+    const matriculaAtiva = (m as any).ativo === true;
+    if (!matriculaAtiva || (statusMatricula && !["ativo", "ativa"].includes(statusMatricula))) {
+      pushPendencia(m, turma, "matricula_pendente");
+      continue;
+    }
+
+    const pricing = await resolvePricing(turma.curso_id, turma.classe_id);
+    if (!pricing) {
+      pushPendencia(m, turma, "pricing_ausente");
+      continue;
+    }
+
+    matriculasValidas.push({
+      id: (m as any).id,
+      aluno_id: (m as any).aluno_id,
+      turma_id: (m as any).turma_id,
+      pricing,
+    });
+  }
+
+  const matriculasMensalidade = new Set<string>();
+  const matriculasParaAbono = new Set<string>();
+
+  for (const m of matriculasValidas) {
+    if (m.pricing.valorMensalidade > 0) matriculasMensalidade.add(m.id);
+    if (skipMatricula && m.pricing.valorMatricula > 0) matriculasParaAbono.add(m.id);
+  }
@@
-  if (clampedMonth > 1 && alunoMensalidade.size > 0) {
-    const alunosChunked = chunk(Array.from(alunoMensalidade), 200);
-    for (const group of alunosChunked) {
+  if (clampedMonth > 1 && matriculasMensalidade.size > 0) {
+    const matriculasChunked = chunk(Array.from(matriculasMensalidade), 200);
+    for (const group of matriculasChunked) {
       await supabase
         .from("mensalidades")
         .update({
           status: "isento" as any,
           valor_previsto: 0,
           valor: 0,
           valor_pago_total: 0,
         })
         .eq("escola_id", escolaId)
         .eq("ano_referencia", anoLetivo)
         .lt("mes_referencia", clampedMonth)
-        .in("aluno_id", group);
+        .in("matricula_id", group);
@@
         .eq("origem", "mensalidade")
         .eq("ano_referencia", anoLetivo)
         .lt("mes_referencia", clampedMonth)
-        .in("aluno_id", group);
+        .in("matricula_id", group);
     }
   }
@@
-  return activeMatriculasCount;
+  return { activeMatriculas: activeMatriculasCount, pendencias };
 }
```
